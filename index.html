<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Multi-Image Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { 
            font-size: 1rem; opacity: 0.9; background: rgba(255,255,255,0.1); 
            padding: 8px 16px; border-radius: 20px; display: inline-block; 
        }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }
        .card {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
        }
        .card h2 { font-size: 1.5rem; margin-bottom: 20px; color: #333; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; }
        .tab-btn {
            flex: 1; padding: 12px; border: 2px solid #4f46e5; background: white; color: #4f46e5;
            border-radius: 10px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; font-weight: 600;
        }
        .tab-btn:hover { background: #f0f0ff; transform: translateY(-2px); }
        .tab-btn.active { background: #4f46e5; color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px;
            font-size: 1rem; min-height: 100px; resize: vertical; font-family: inherit;
        }
        .form-group textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .upload-area {
            border: 2px dashed #4f46e5; border-radius: 10px; padding: 30px; text-align: center;
            cursor: pointer; background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%); transition: all 0.3s;
        }
        .upload-area:hover { background: linear-gradient(135deg, #f0f2ff 0%, #e8ebff 100%); transform: translateY(-2px); }
        .upload-area.drag-over { background: #e8ebff; border-color: #5568d3; transform: scale(1.02); }
        .upload-icon { font-size: 3rem; margin-bottom: 10px; }
        .file-input { display: none; }
        .multi-file-input { display: none; }
        .preview-container { margin-top: 20px; }
        .preview-image { max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 10px; }
        
        /* Multi-image styles */
        .multi-upload-area {
            border: 2px dashed #ec4899; border-radius: 10px; padding: 30px; text-align: center;
            cursor: pointer; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); transition: all 0.3s;
        }
        .multi-upload-area:hover { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); transform: translateY(-2px); }
        .multi-upload-area.drag-over { background: #fbcfe8; border-color: #db2777; transform: scale(1.02); }
        .multi-preview-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;
        }
        .multi-image-item {
            position: relative; background: #f8f9ff; border-radius: 10px; padding: 10px;
            border: 1px solid #e0e0e0;
        }
        .multi-image-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; }
        .remove-image {
            position: absolute; top: 5px; right: 5px; background: #ef4444; color: white;
            border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
        }
        .image-counter {
            text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem;
            background: #f0f0f0; padding: 5px 10px; border-radius: 15px; display: inline-block;
        }
        
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; transition: all 0.3s; letter-spacing: 0.3px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }
        .btn-combine {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }
        .btn-primary:hover:not(:disabled), .btn-combine:hover:not(:disabled) { 
            transform: translateY(-3px); box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5); 
        }
        .btn-primary:disabled, .btn-combine:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; font-weight: 600; }
        .btn-secondary:hover { background: #e0e0e0; transform: translateY(-2px); }
        
        .result-area { text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; }
        .result-placeholder { color: #999; font-size: 1.1rem; padding: 60px 20px; }
        .result-image { max-width: 100%; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); }
        .loading { text-align: center; padding: 50px 20px; }
        .loading-spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 25px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 1.2rem; color: #555; margin-bottom: 10px; font-weight: 600; }
        .loading-hint { font-size: 0.95rem; color: #999; }
        .status-message {
            padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: 500;
        }
        .status-message.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .status-message.info { background: #e8ebff; color: #4f46e5; border: 2px solid #c3c6e8; }
        .footer { text-align: center; color: white; padding: 30px 20px; opacity: 0.9; margin-top: 40px; }
        .gemini-badge {
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc04, #ea4335);
            color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;
        }
        .multi-badge {
            background: linear-gradient(45deg, #ec4899, #8b5cf6);
            color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;
        }
        .example-prompts {
            background: #f8f9ff; border-radius: 8px; padding: 15px; margin-top: 10px;
            font-size: 0.9rem; color: #666;
        }
        .example-prompts .title { font-weight: 600; margin-bottom: 8px; color: #333; }
        .example-prompts .item { margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Gemini Multi-Image Generator</h1>
            <div class="subtitle">
                <span class="gemini-badge">Google AI</span>
                <span class="multi-badge">Multi-Image</span>
                –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>‚ö° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('generate')">üé® –°–æ–∑–¥–∞—Ç—å</button>
                    <button class="tab-btn" onclick="switchTab('edit')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="tab-btn" onclick="switchTab('combine')">üîÑ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞: –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <div id="generate-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="prompt">üìù –û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                        <textarea id="prompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ –Ω–∞ –∑–∞–∫–∞—Ç–µ —Å –ª–µ—Ç–∞—é—â–∏–º–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏ –∏ –Ω–µ–æ–Ω–æ–≤—ã–º–∏ –æ–≥–Ω—è–º–∏"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="generateImage()">üöÄ –°–æ–∑–¥–∞—Ç—å —Å Gemini</button>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <div id="edit-tab" class="tab-content">
                    <div class="form-group">
                        <label>üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">üì§</div>
                            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                            <input type="file" id="imageInput" class="file-input" accept="image/*">
                        </div>
                        <div id="previewContainer" class="preview-container" style="display: none;">
                            <img id="previewImage" class="preview-image" alt="Preview">
                            <button class="btn btn-secondary" onclick="clearImage()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPrompt">‚ú® –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                        <textarea id="editPrompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–¥–µ–ª–∞–π –Ω–µ–±–æ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º, –¥–æ–±–∞–≤—å –∑–≤–µ–∑–¥—ã, –∏–∑–º–µ–Ω–∏ —Å—Ç–∏–ª—å –Ω–∞ –≤–∏–Ω—Ç–∞–∂–Ω—ã–π"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="editImage()" id="editBtn" disabled>üé® –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å Gemini</button>
                </div>

                <!-- –í–∫–ª–∞–¥–∫–∞: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div id="combine-tab" class="tab-content">
                    <div class="form-group">
                        <label>üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (2-10):</label>
                        <div class="multi-upload-area" id="multiUploadArea">
                            <div class="upload-icon">üì§</div>
                            <p><strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—é–¥–∞</strong></p>
                            <p style="font-size: 0.9rem; margin-top: 5px;">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</p>
                            <input type="file" id="multiImageInput" class="multi-file-input" accept="image/*" multiple>
                        </div>
                        <div id="multiPreviewContainer" class="multi-preview-container"></div>
                        <div id="imageCounter" class="image-counter" style="display: none;">
                            –ó–∞–≥—Ä—É–∂–µ–Ω–æ: <span id="imageCount">0</span> –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="combinePrompt">üîÑ –ö–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                        <textarea id="combinePrompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–π –∫–æ–ª–ª–∞–∂ –≤ —Å—Ç–∏–ª–µ –≤–∏–Ω—Ç–∞–∂, –æ–±—ä–µ–¥–∏–Ω–∏ –≤ –æ–¥–Ω—É –ø–∞–Ω–æ—Ä–∞–º—É, —Å–æ–∑–¥–∞–π —Å—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é"></textarea>
                        <div class="example-prompts">
                            <div class="title">üí° –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:</div>
                            <div class="item">‚Ä¢ "–°–æ–∑–¥–∞–π –ø–∞–Ω–æ—Ä–∞–º—É –∏–∑ —ç—Ç–∏—Ö –ø–µ–π–∑–∞–∂–µ–π"</div>
                            <div class="item">‚Ä¢ "–û–±—ä–µ–¥–∏–Ω–∏ –≤ –∫–æ–ª–ª–∞–∂ –≤ —Å—Ç–∏–ª–µ Instagram"</div>
                            <div class="item">‚Ä¢ "–°–æ–∑–¥–∞–π —Å—é—Ä—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é"</div>
                            <div class="item">‚Ä¢ "–°–¥–µ–ª–∞–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—Ä—Ç –≤ —Å—Ç–∏–ª–µ cyberpunk"</div>
                        </div>
                    </div>
                    <button class="btn btn-combine" onclick="combineImages()" id="combineBtn" disabled>üîÑ –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å Gemini</button>
                </div>
            </div>

            <div class="card">
                <h2>üé® –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                <div id="resultArea" class="result-area">
                    <p class="result-placeholder">
                        –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–Ω–Ω–æ–µ Gemini 2.5 Flash<br>
                        <span style="font-size: 0.9rem; opacity: 0.7;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ç–≤–æ—Ä–∏—Ç—å! ‚ú®</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Powered by Google Gemini 2.5 Flash Image Preview —á–µ—Ä–µ–∑ OpenRouter</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">‚ö° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® WEBHOOK URL –ò–ó N8N ‚ö†Ô∏è
        const WEBHOOK_URL = 'https://flashbooostern8n.ru/webhook/gemini-multi-image';
        // ‚ö†Ô∏è –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ Production URL –∏–∑ —É–∑–ª–∞ Webhook ‚ö†Ô∏è
        
        let uploadedImage = null;
        let uploadedImages = [];
        const MAX_IMAGES = 10;

        // üî• –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        async function compressImage(file, maxWidth = 1024, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —Å —Å–∂–∞—Ç–∏–µ–º JPEG
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∞—Ç–æ: ${file.size} ‚Üí ${compressedDataUrl.length} –±–∞–π—Ç`);
                        resolve(compressedDataUrl);
                    };
                    
                    img.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                    img.src = e.target.result;
                };
                
                reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
                reader.readAsDataURL(file);
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        const uploadArea = document.getElementById('uploadArea');
        const imageInput = document.getElementById('imageInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');

        uploadArea.addEventListener('click', () => imageInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            if (e.dataTransfer.files[0]) handleSingleFile(e.dataTransfer.files[0]);
        });
        imageInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleSingleFile(e.target.files[0]);
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const multiUploadArea = document.getElementById('multiUploadArea');
        const multiImageInput = document.getElementById('multiImageInput');
        const multiPreviewContainer = document.getElementById('multiPreviewContainer');
        const imageCounter = document.getElementById('imageCounter');
        const imageCountSpan = document.getElementById('imageCount');

        multiUploadArea.addEventListener('click', () => multiImageInput.click());
        multiUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            multiUploadArea.classList.add('drag-over');
        });
        multiUploadArea.addEventListener('dragleave', () => multiUploadArea.classList.remove('drag-over'));
        multiUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            multiUploadArea.classList.remove('drag-over');
            handleMultipleFiles(e.dataTransfer.files);
        });
        multiImageInput.addEventListener('change', (e) => {
            handleMultipleFiles(e.target.files);
        });

        // üî• –û–ë–ù–û–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å —Å–∂–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        async function handleSingleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                showStatus('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }
            
            try {
                showStatus('üîÑ –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'info');
                
                // üî• –°–ñ–ò–ú–ê–ï–ú –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï
                const compressedImage = await compressImage(file, 1024, 0.8);
                
                uploadedImage = compressedImage;
                previewImage.src = compressedImage;
                previewContainer.style.display = 'block';
                uploadArea.style.display = 'none';
                document.getElementById('editBtn').disabled = false;
                
                showStatus('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é', 'success');
            } catch (error) {
                console.error('Error compressing image:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // üî• –û–ë–ù–û–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å —Å–∂–∏–º–∞–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        async function handleMultipleFiles(files) {
            const fileArray = Array.from(files);
            const imageFiles = fileArray.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', 'error');
                return;
            }

            if (uploadedImages.length + imageFiles.length > MAX_IMAGES) {
                showStatus(`‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º ${MAX_IMAGES} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'error');
                return;
            }

            showStatus(`üîÑ –°–∂–∞—Ç–∏–µ ${imageFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...`, 'info');

            try {
                // üî• –°–ñ–ò–ú–ê–ï–ú –í–°–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
                for (const file of imageFiles) {
                    const compressedImage = await compressImage(file, 1024, 0.8);
                    uploadedImages.push(compressedImage);
                }
                
                updateMultiPreview();
                showStatus(`‚úÖ ${imageFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≥–æ—Ç–æ–≤—ã –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é`, 'success');
            } catch (error) {
                console.error('Error compressing images:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ' + error.message, 'error');
            }
        }

        function updateMultiPreview() {
            multiPreviewContainer.innerHTML = '';
            
            uploadedImages.forEach((imageData, index) => {
                const item = document.createElement('div');
                item.className = 'multi-image-item';
                item.innerHTML = `
                    <img src="${imageData}" class="multi-image-preview" alt="Image ${index + 1}">
                    <button class="remove-image" onclick="removeImage(${index})">√ó</button>
                `;
                multiPreviewContainer.appendChild(item);
            });

            imageCountSpan.textContent = uploadedImages.length;
            imageCounter.style.display = uploadedImages.length > 0 ? 'block' : 'none';
            document.getElementById('combineBtn').disabled = uploadedImages.length < 2;
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateMultiPreview();
        }

        function clearImage() {
            uploadedImage = null;
            previewContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            imageInput.value = '';
            document.getElementById('editBtn').disabled = true;
        }

        function clearMultiImages() {
            uploadedImages = [];
            updateMultiPreview();
        }

        async function generateImage() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                showStatus('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }

            showLoading('üß† Gemini —Å–æ–∑–¥–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é...');

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'generate', prompt: prompt })
                });

                const data = await response.json();
                if (data.success && data.imageUrl) {
                    showResult(data.imageUrl);
                    showStatus('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', 'success');
                } else {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                showPlaceholder();
            }
        }

        async function editImage() {
            const editPrompt = document.getElementById('editPrompt').value.trim();
            if (!editPrompt) {
                showStatus('‚ö†Ô∏è –û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }
            if (!uploadedImage) {
                showStatus('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }

            showLoading('‚ú® Gemini –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'edit', prompt: editPrompt, image: uploadedImage })
                });

                const data = await response.json();
                if (data.success && data.imageUrl) {
                    showResult(data.imageUrl);
                    showStatus('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
                } else {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                showPlaceholder();
            }
        }

        async function combineImages() {
            const combinePrompt = document.getElementById('combinePrompt').value.trim();
            if (!combinePrompt) {
                showStatus('‚ö†Ô∏è –û–ø–∏—à–∏—Ç–µ –∫–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }
            if (uploadedImages.length < 2) {
                showStatus('‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }

            showLoading(`üîÑ Gemini –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç ${uploadedImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...`);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: 'combine', 
                        prompt: combinePrompt, 
                        images: uploadedImages 
                    })
                });

                const data = await response.json();
                if (data.success && data.imageUrl) {
                    showResult(data.imageUrl);
                    showStatus(`‚úÖ ${uploadedImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã!`, 'success');
                } else {
                    throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                showPlaceholder();
            }
        }

        function showLoading(message) {
            document.getElementById('resultArea').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">${message}</p>
                    <p class="loading-hint">–ú–Ω–æ–≥–æ–∏–∑–æ–±—Ä–∞–∂–µ–Ω—å–µ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ ‚è±Ô∏è</p>
                </div>
            `;
        }

        function showResult(imageUrl) {
            document.getElementById('resultArea').innerHTML = `
                <img src="${imageUrl}" class="result-image" alt="Generated by Gemini">
                <button class="btn btn-secondary" onclick="downloadImage('${imageUrl}')">
                    üíæ –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
            `;
        }

        function showPlaceholder() {
            document.getElementById('resultArea').innerHTML = 
                '<p class="result-placeholder">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ<br><span style="font-size: 0.9rem; opacity: 0.7;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</span></p>';
        }

        function showStatus(message, type) {
            const resultArea = document.getElementById('resultArea');
            const existing = resultArea.querySelector('.status-message');
            if (existing) existing.remove();

            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
            resultArea.insertBefore(statusDiv, resultArea.firstChild);
            setTimeout(() => statusDiv.remove(), 7000);
        }

        function downloadImage(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gemini-multi-generated-' + Date.now() + '.png';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        window.addEventListener('load', () => {
            if (WEBHOOK_URL.includes('your-n8n-instance.com')) {
                showStatus('‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ WEBHOOK_URL –≤ –∫–æ–¥–µ!', 'error');
            }
        });
    </script>
</body>
</html>
